<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Narração com Gemini</title>
    <!-- Link para CSS (se você tiver um arquivo style.css na pasta static/css) -->
    <!-- Se não tiver CSS, pode remover esta linha -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        /* Estilos básicos para demonstração. Adapte conforme sua necessidade. */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background-color: #f4f7f6; /* Um fundo suave */
            color: #333;
            line-height: 1.6;
        }
        .container {
            max-width: 700px; /* Largura um pouco menor */
            margin: 30px auto; /* Mais espaço acima e abaixo */
            background: #ffffff; /* Fundo branco para o card */
            padding: 30px; /* Mais padding interno */
            border-radius: 12px; /* Bordas mais arredondadas */
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); /* Sombra mais proeminente */
            text-align: center; /* Centraliza o conteúdo */
        }
        h1 {
            color: #007bff; /* Azul vibrante para o título */
            margin-bottom: 25px;
            font-size: 2.2em;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600; /* Fonte mais grossa */
            text-align: left; /* Alinha labels à esquerda */
            color: #555;
        }
        textarea {
            width: calc(100% - 22px); /* Ajusta a largura para o padding */
            padding: 12px;
            margin-bottom: 20px;
            border: 1px solid #ced4da; /* Borda mais suave */
            border-radius: 6px;
            min-height: 120px; /* Altura maior para o textarea */
            font-size: 1em;
            resize: vertical; /* Permite redimensionamento vertical */
        }
        textarea:focus {
            border-color: #007bff; /* Muda a cor da borda ao focar */
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
            outline: none;
        }
        select {
            width: 100%;
            padding: 12px;
            margin-bottom: 20px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 1em;
            background-color: #fff; /* Fundo branco para o select */
            appearance: none; /* Remove a aparência padrão do navegador */
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url('data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chevron-down" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 .708-.708z"/></svg>'); /* Seta customizada */
            background-repeat: no-repeat;
            background-position: right 12px center; /* Posição da seta */
            background-size: 16px; /* Tamanho da seta */
        }
        select:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
            outline: none;
        }
        button {
            background-color: #28a745; /* Verde vibrante */
            color: white;
            padding: 14px 25px; /* Mais padding para o botão */
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1.1em; /* Tamanho da fonte do botão */
            transition: background-color 0.3s ease; /* Transição suave ao passar o mouse */
            width: 100%;
        }
        button:hover {
            background-color: #218838; /* Verde mais escuro no hover */
        }
        button:disabled {
            background-color: #6c757d; /* Cor para botão desabilitado */
            cursor: not-allowed;
        }
        #loading {
            text-align: center;
            margin-top: 20px;
            color: #6c757d; /* Cinza suave para o texto de carregamento */
            font-style: italic;
        }
        #audioPlayerContainer {
            margin-top: 30px;
            text-align: center;
        }
        audio {
            width: 100%; /* Garante que o player de áudio ocupe a largura */
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Gerador de Narração com Gemini TTS</h1>

        <div>
            <label for="textInput">Digite o texto para narrar:</label>
            <textarea id="textInput" placeholder="Ex: Olá! Este é um teste de narração com vozes de alta qualidade."></textarea>
        </div>

        <div>
            <label for="voiceSelector">Escolha um locutor:</label>
            {# O select estará vazio inicialmente, será populado pelo JS externo #}
            <select id="voiceSelector">
                <option value="">-- Selecione um locutor --</option>
            </select>
        </div>

        <button id="generateButton">GERAR NARRAÇÃO</button>
        <div id="loading">Gerando narração... Por favor, aguarde.</div>

        <div id="audioPlayerContainer">
            <!-- O player de áudio será inserido aqui pelo JavaScript -->
        </div>
    </div>

    <!-- Carrega o arquivo JavaScript com os dados das vozes e a lógica de popular o select -->
    <!-- Certifique-se que o caminho está correto para onde você enviou o arquivo na Hostinger -->
    <script src="static/js/voices.js"></script>

    <script>
        // Aguarda o DOM estar completamente carregado antes de executar o script.
        // Isso garante que o elemento <select id="voiceSelector"> já exista na página.
        document.addEventListener('DOMContentLoaded', () => {
            // Chama a função do arquivo voices.js para popular o dropdown de locutores.
            populateVoiceSelector('voiceSelector');
        });

        // --- Referências aos elementos do DOM ---
        const textInput = document.getElementById('textInput');
        const voiceSelector = document.getElementById('voiceSelector');
        const generateButton = document.getElementById('generateButton');
        const loadingIndicator = document.getElementById('loading');
        const audioPlayerContainer = document.getElementById('audioPlayerContainer');

        // --- Configuração do Backend ---
        // URL base da sua aplicação backend rodando no Render.com.
        // Certifique-se de que esta URL está correta.
        const backendUrl = 'https://site-z95m.onrender.com';

        // --- Event Listener para o botão Gerar Narração ---
        generateButton.addEventListener('click', async () => {
            const text = textInput.value.trim(); // Pega o texto digitado, removendo espaços extras.
            const voiceId = voiceSelector.value; // Pega o ID do locutor selecionado.

            // Validações básicas antes de enviar para o backend.
            if (!text) {
                alert('Por favor, digite um texto para narrar.');
                return; // Interrompe a função se não houver texto.
            }
            if (!voiceId) {
                alert('Por favor, selecione um locutor.');
                return; // Interrompe a função se nenhum locutor for selecionado.
            }

            // --- Lógica de Carregamento e Desabilitação ---
            loadingIndicator.style.display = 'block'; // Mostra o indicador de carregamento.
            generateButton.disabled = true;           // Desabilita o botão para evitar cliques múltiplos.
            audioPlayerContainer.innerHTML = '';      // Limpa qualquer player de áudio anterior.

            try {
                // --- Chamada para o Backend ---
                const response = await fetch(`${backendUrl}/generate-narration`, {
                    method: 'POST', // Método HTTP POST.
                    headers: {
                        'Content-Type': 'application/json' // Indica que o corpo da requisição é JSON.
                    },
                    body: JSON.stringify({ text: text, voiceId: voiceId }) // Envia o texto e o ID do locutor em formato JSON.
                });

                // --- Processamento da Resposta do Backend ---
                const data = await response.json(); // Converte a resposta JSON em um objeto JavaScript.

                if (response.ok) {
                    // Se a requisição foi bem sucedida (status 2xx).
                    const audioBase64 = data.audioContent; // Pega o conteúdo de áudio em base64.
                    const audioBlob = base64ToBlob(audioBase64, 'audio/wav'); // Converte base64 para um Blob de áudio.
                    const audioUrl = URL.createObjectURL(audioBlob); // Cria uma URL temporária para o áudio.

                    // Cria um elemento de áudio HTML5 para reproduzir o som.
                    const audioElement = document.createElement('audio');
                    audioElement.controls = true; // Adiciona os controles de reprodução (play, pause, volume).
                    audioElement.src = audioUrl;   // Define a fonte do áudio.
                    audioPlayerContainer.appendChild(audioElement); // Adiciona o player de áudio à página.

                    // --- Limpeza da URL de Objeto ---
                    // Libera a memória usada pela URL de objeto quando o áudio terminar de tocar
                    // ou se houver um erro.
                    audioElement.onended = () => URL.revokeObjectURL(audioUrl);
                    audioElement.onerror = () => URL.revokeObjectURL(audioUrl);

                } else {
                    // Se a requisição retornou um erro (status 4xx ou 5xx).
                    alert(`Erro: ${data.error || 'Erro desconhecido ao receber a resposta do servidor.'}`);
                }
            } catch (error) {
                // Captura erros de rede ou outros problemas durante a requisição fetch.
                console.error('Erro na requisição fetch:', error);
                alert('Ocorreu um erro ao se comunicar com o servidor. Verifique sua conexão ou tente novamente.');
            } finally {
                // Este bloco é executado independentemente de a requisição ter sido bem sucedida ou não.
                loadingIndicator.style.display = 'none'; // Esconde o indicador de carregamento.
                generateButton.disabled = false;           // Reabilita o botão.
            }
        });

        // --- Função Auxiliar: Converter Base64 para Blob ---
        // Usada para criar um objeto de áudio a partir da string base64 retornada pelo backend.
        function base64ToBlob(base64, type = 'audio/wav') {
            const byteCharacters = atob(base64); // Decodifica a string base64.
            const byteNumbers = new Array(byteCharacters.length);
            for (let i = 0; i < byteCharacters.length; i++) {
                byteNumbers[i] = byteCharacters.charCodeAt(i); // Converte cada caractere em seu código ASCII.
            }
            const byteArray = new Uint8Array(byteNumbers); // Cria um ArrayBuffer com os bytes.
            return new Blob([byteArray], { type }); // Cria um Blob do tipo de áudio especificado.
        }
    </script>
</body>
</html>